<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Image-based Workflow • theRmalUAV</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Image-based Workflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">theRmalUAV</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Image-based Workflow</h1>
            
      

      <div class="d-none name"><code>Image-based_Workflow.Rmd</code></div>
    </div>

    
    
<style>
body {
text-align: justify}
</style>
<div class="section level2">
<h2 id="overview">1. Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>In this article we will go over the image-based workflow step by
step. The image-based workflow is intended to perform corrections at
image level. The following figure provides a more detailed overview of
the image-based workflow, indicating additional functionalities. The
different steps will be explained suing two examples:</p>
<ul>
<li><a href="#basic-workflow-with-dji-matrice-3t">2. Basic workflow with
DJI Matrice 3T</a></li>
<li><a href="#advanced-workflow-with-teax-thermalcapture-2.0">3.
Advanced workflow with TeAx ThermalCapture 2.0</a></li>
</ul>
<p><img src="figures%2FWorkflow_image_based_3.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="basic-workflow-with-dji-matrice-3t">2. Basic workflow with DJI Matrice 3T<a class="anchor" aria-label="anchor" href="#basic-workflow-with-dji-matrice-3t"></a>
</h2>
<p>First things first, before we start we need to load the R package in
our environment:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://christophemetsu.github.io/theRmalUAV/">theRmalUAV</a></span><span class="op">)</span></span></code></pre></div>
<p>Once this is complete we can call the functions embedded in the R
package</p>
<p>When using DJI cameras in the image-based workflow, the package
utilizes the DJI Thermal SDK functionality provided by DJI. The package
uses python in the background to access the libraries provided by DJI.
Therefore, in order to work with DJI cameras you first need to do some
initial steps. Please read the <code><a href="../articles/DJI_cameras.html">vignette("DJI_cameras")</a></code>
first before proceeding.</p>
<div class="section level3">
<h3 id="create-a-thermaluav-object">2.1. Create a ThermalUAV object<a class="anchor" aria-label="anchor" href="#create-a-thermaluav-object"></a>
</h3>
<p>The image-based workflow always starts with creating a ThermalUAV
object using the function <code><a href="../reference/tuav_create.html">tuav_create()</a></code>. Here we will give
the name “thermal_uav” to the ThermalUAV object. The path refers to the
path on your pc to the folder containing the TIFF/jpg files, or path to
1 TIFF/jpg file. The camera name can be found by running the function
<code><a href="../reference/tuav_cameras.html">tuav_cameras()</a></code>. The flight_height is our case 75 meters. No
external metadata dataframe is available so we set it to NA, this way
only the meta data stored in exif will be used.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thermal_uav</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tuav_create.html">tuav_create</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"E:/Thermal_Project/Thermal_data_dji"</span>,</span>
<span>                           camera <span class="op">=</span> <span class="st">"DJI_M3T"</span>,</span>
<span>                           meta_csv <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                           flight_height <span class="op">=</span> <span class="fl">75</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="conversion-to-lst">2.2. Conversion to LST<a class="anchor" aria-label="anchor" href="#conversion-to-lst"></a>
</h3>
<p>After creating the ThermalUAV you can already correct the data using
the function <code><a href="../reference/tuav_correct.html">tuav_correct()</a></code>. Here, atmospheric data is
required, use the expression “?tuav_correct()” to check which formats
can be used. In this example we keep it simple and will only use one
value for each atmospheric parameter, as the flight was relatively short
and was performed under stable weather conditions. The values were
measured using the portable Kestrel 5000 weather station. The parameter
flight_height is set to NA to use the height as defined in
<code><a href="../reference/tuav_create.html">tuav_create()</a></code>. Emissivity is set to 0.985, a commonly used
value for vegetation. To obtain the background temperature
<code>T_bg</code> in Kelvin, the brightness temperature of crumpled
aluminium foil was used.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thermal_uav_correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tuav_correct.html">tuav_correct</a></span><span class="op">(</span><span class="va">thermal_uav</span>,          </span>
<span>                                    flight_height <span class="op">=</span> <span class="cn">NA</span>,   <span class="co"># in meters</span></span>
<span>                                    T_air <span class="op">=</span> <span class="fl">28.7</span>,         <span class="co"># in °C</span></span>
<span>                                    rel_hum <span class="op">=</span> <span class="fl">47.2</span>,       <span class="co"># in %</span></span>
<span>                                    T_bg <span class="op">=</span> <span class="fl">282.37</span>,        <span class="co"># in Kelvin</span></span>
<span>                                    emiss <span class="op">=</span> <span class="fl">0.985</span><span class="op">)</span>        </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="export-and-report">2.3. Export and report<a class="anchor" aria-label="anchor" href="#export-and-report"></a>
</h3>
<p>Now the most basic, essential correction is done, and we can export
the data to convert the images into a LST orthomosaic. To export the
data, use the function <code><a href="../reference/tuav_export.html">tuav_export()</a></code>. Make sure you use the
most up-to-date ThermalUAV object, holding the thermal information and
latest corrections. Set <code>export_path</code> if you want to store
the data somewhere specific. Here we use the default ‘NA’, to create a
new folder, names “corrected”, within the original folder.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tuav_export.html">tuav_export</a></span><span class="op">(</span><span class="va">thermal_uav_correct</span>,</span>
<span>            export_path <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>     </span></code></pre></div>
<p>Optionally, if desired, you can also create an HTM-report using
<code><a href="../reference/tuav_report.html">tuav_report()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tuav_report.html">tuav_report</a></span><span class="op">(</span><span class="va">thermal_uav_correct</span>,</span>
<span>            project_name <span class="op">=</span> <span class="st">"Thermal_Project_DJI"</span>,</span>
<span>            flight_name <span class="op">=</span> <span class="st">"Flight 1"</span>,</span>
<span>            pilot_name <span class="op">=</span> <span class="st">"Pilot X"</span>,</span>
<span>            location <span class="op">=</span> <span class="st">"Flightblock Y"</span><span class="op">)</span>     </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="optional-spatial-emissivity-correction">2.4. Optional Spatial Emissivity Correction<a class="anchor" aria-label="anchor" href="#optional-spatial-emissivity-correction"></a>
</h3>
<p>After stitching the exported corrected LST tiff files, you obtain a
LST orthomosaic. This LST map assumes one emissvivty value for the whole
area. If you flew over a region with a lot of different land covers,
some parts might be over/under estimated due to a wrong emissivity
value. For example, the thermal emissivity for bare soil, vegetation and
water differ. You can account for this using the NDVI threshold method,
a landcover (LC) map or directly through an emissivity map if available
see vignette(“Background”) for more information. The NDVI, LC or
emissvity map does not necessarily have to be taken at the same day or
resolution. However, it must completely cover the LST orthomosaic.</p>
<p>In this example we will use the NDVI threshold method. The
multispectral (MSP) data was obtained using the Micasense Altum-PT on
the same day and processed in Agisoft Metashape using <a href="https://agisoft.freshdesk.com/support/solutions/articles/31000148381-micasense-altum-processing-workflow-including-reflectance-calibration-in-agisoft-metashape-professi" class="external-link">this
workflow</a>. The reflectance was calibrated using a 50% calibration
panel. The MSP orthomosaic is first loaded to create an NDVI map. You
can use the <a href="https://rspatial.github.io/terra/" class="external-link">terra
package</a> to work with rasters in R.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the MSP data as SpatRaster</span></span>
<span><span class="va">MSP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"E:/Thermal_Project/MSP_ortho_dji.tif"</span><span class="op">)</span></span>
<span><span class="co"># Create NDVI using the NIR and RED band</span></span>
<span><span class="va">NDVI</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">MSP</span><span class="op">$</span><span class="va">NIR</span> <span class="op">-</span> <span class="va">MSP</span><span class="op">$</span><span class="va">RED</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">MSP</span><span class="op">$</span><span class="va">NIR</span> <span class="op">+</span> <span class="va">MSP</span><span class="op">$</span><span class="va">RED</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">NDVI</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"NDVI"</span></span>
<span></span>
<span><span class="co"># Load the LST data as SpatRaster</span></span>
<span><span class="va">LST</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"E:/Thermal_Project/LST_ortho_dji.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">NDVI</span>, main <span class="op">=</span> <span class="st">"NDVI"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LST</span>, main <span class="op">=</span> <span class="st">"Land surface temperature in °C"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"magma"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures%2FIm_dji_NDVI.png" width="100%"><img src="figures%2FIm_dji_LST.png" width="100%"></p>
<p>Once the NDVI map is created, we can account for the emissivity in a
spatially explicit way using the NDVI threshold method. In this example
we are going to set tho following parameters, the emissivity values were
taken from <a href="https://doi.org/10.1016/S0034-4257(96)00123-X" class="external-link">this
paper</a>: - NDVI<sub>veg</sub> = 0.8 - NDVI<sub>soil</sub> = 0.1 -
ϵ<sub>veg</sub> = 0.984 (Emissivity for shrubs) - ϵ<sub>soil</sub> =
0.914 (Emissivity for sandsoils)</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LST_emis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tuav_emis.html">tuav_emis</a></span><span class="op">(</span>thermal_orig <span class="op">=</span> <span class="va">LST</span>,</span>
<span>                      thermal_uav <span class="op">=</span> <span class="va">thermal_uav_correct</span>, <span class="co"># The last ThermalUAV object, </span></span>
<span>                      temp <span class="op">=</span> <span class="st">"C"</span>, <span class="co"># LST is in this case in °C</span></span>
<span>                      corrmap <span class="op">=</span> <span class="va">NDVI</span>,</span>
<span>                      method <span class="op">=</span> <span class="st">"NDVI"</span>, <span class="co"># Here we use the NDVI method</span></span>
<span>                      write_Ts <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># If you want to write the output</span></span>
<span>                      filename_Ts <span class="op">=</span> <span class="st">"E:/Thermal_Project/LST_ortho_dji_emis.tif"</span>,</span>
<span>                      write_emiss <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># Optionally you can save the emissivity raster file</span></span>
<span>                      filename_emiss <span class="op">=</span> <span class="st">"E:/Thermal_Project/Emis_ortho_dji.tif"</span>,</span>
<span>                      NDVI_veg <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>                      NDVI_soil <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>                      emiss_veg <span class="op">=</span> <span class="fl">0.984</span>,</span>
<span>                      emiss_soil <span class="op">=</span> <span class="fl">0.914</span><span class="op">)</span></span></code></pre></div>
<p>After correcting for the spatially explicit emissivity, the LST map
is final and can be plotted or used for your analysis. Please note, in
this example a small part is covered by water. The emissivity of water
is slightly higher than that for shrubs. Careful interpretation of the
water temperatures is thus required.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LST_emis</span>, main <span class="op">=</span> <span class="st">"LST corrected for ϵ"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"magma"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures%2FIm_dji_LST_emis.png" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="advanced-workflow-with-teax-thermalcapture-2-0">3. Advanced workflow with TeAx ThermalCapture 2.0<a class="anchor" aria-label="anchor" href="#advanced-workflow-with-teax-thermalcapture-2-0"></a>
</h2>
<p>In this example we will dive into a more advance case using the
ThermalCapture 2.0. This thermal camera records at 8.33 Hz, meaning we
have slightly more than 8 thermal images per second. We will discuss how
you can reduce the data volume in an efficient way, while retaining
maximal quality. Furthermore, we will discuss how the co-registration
works, in this case with the Micasense Altum-PT. As the flight in this
example is quite long covering 17 ha, we will use atmospheric data
recorded at high frequency. But, first things first, we have to create a
ThermalUAV object.</p>
<div class="section level3">
<h3 id="create-a-thermaluav-object-1">3.1. Create a ThermalUAV object<a class="anchor" aria-label="anchor" href="#create-a-thermaluav-object-1"></a>
</h3>
<p>As in section <a href="#create-a-thermaluav-object">2.1. Create a
ThermalUAV object</a> we will create a ThermalUAV object using the
function <code><a href="../reference/tuav_create.html">tuav_create()</a></code>. The ThermalCapture line from TeAx,
stores thermal data as a “.TMC” file. They provide a software called
ThermoViewer to convert the TMC files into TIFF files containing the
thermal data. This software provides the option to store the metadata of
all images in ONE csv file. This csv file can be used as additional meta
data in the <code><a href="../reference/tuav_create.html">tuav_create()</a></code> function.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thermal_uav_teax</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tuav_create.html">tuav_create</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"E:/Thermal_Project/Thermal_data_TeAx/"</span>,</span>
<span>                                camera <span class="op">=</span> <span class="st">"ThermalCapture"</span>,</span>
<span>                                meta_csv <span class="op">=</span> <span class="st">"E:/Thermal_Project/Thermal_data_TeAx/Thermal_Project_meta.csv"</span>,</span>
<span>                                flight_height <span class="op">=</span> <span class="fl">75</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="check-and-clean-the-data">3.2. Check and clean the data<a class="anchor" aria-label="anchor" href="#check-and-clean-the-data"></a>
</h3>
<p>The data volume is quite high (16612 images) as you can see with the
following code:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thermal_uav_teax</span><span class="op">@</span><span class="va">Info</span><span class="op">@</span><span class="va">dataset_length</span>                           </span></code></pre></div>
<p>You can also check the visually where all these images are located in
space using the following code:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thermal_uav_teax_loc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tuav_loc.html">tuav_loc</a></span><span class="op">(</span><span class="va">thermal_uav_teax</span>,</span>
<span>                                 extent <span class="op">=</span> <span class="cn">TRUE</span>,   <span class="co"># Calculate the image extents</span></span>
<span>                                 overlap <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="co"># Calculate the mean frontal overlap</span></span>
<span></span>
<span><span class="va">thermal_uav_teax_loc</span><span class="op">@</span><span class="va">Position</span><span class="op">@</span><span class="va">overlap</span></span>
<span><span class="fu"><a href="../reference/tuav_view.html">tuav_view</a></span><span class="op">(</span><span class="va">thermal_uav_teax_loc</span>, extent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>If all these images need to be converted, it might require a lot of
computing power. Generally, we also don’t need around 8 images per
second, resulting in a mean frontal overlap of 98.7 %. This R package
offers two functions to deal with data reduction. Either you keep a
predefined amount of images per second using <code><a href="../reference/tuav_persec.html">tuav_persec()</a></code>,
or you set a minimal threshold for overlap or sharpness with
<code><a href="../reference/tuav_reduc.html">tuav_reduc()</a></code>. You can call “?tuav_reduc” to get more
information on the function’s parameters. Here we will use the method
overlap, which means the algorithm will select images to result in a
frontal overlap of the given value (in this case 0.9 for a frontal
overlap of 90%). The algorithm will only select images with enough
quality (i.e. above the sharpness_threshold). If this latter requirement
is not met, it will take the best option below this threshold to still
ensure the minimal required overlap. In this case, it will provide a
list on which images where kept, but do not meet the required quality
checks. Lastly, you have the option to delete the images from your local
storage (be careful with this option), or you can just move the images
to a different folder (= DEFAULT).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thermal_uav_teax_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tuav_reduc.html">tuav_reduc</a></span><span class="op">(</span><span class="va">thermal_uav_teax_loc</span>,</span>
<span>                                     method <span class="op">=</span> <span class="st">"Overlap"</span>,</span>
<span>                                     min_overlap <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>                                     sharpness_threshold <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                                     remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>You can see that the mean frontal overlap is reduced and visualize it
with the interactive map:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thermal_uav_teax_clean</span><span class="op">@</span><span class="va">Position</span><span class="op">@</span><span class="va">overlap</span></span>
<span><span class="fu"><a href="../reference/tuav_view.html">tuav_view</a></span><span class="op">(</span><span class="va">thermal_uav_teax_clean</span>, extent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="co-regsitration-with-micasense-altum-pt">3.3. Co-regsitration with Micasense Altum-PT<a class="anchor" aria-label="anchor" href="#co-regsitration-with-micasense-altum-pt"></a>
</h3>
<p>The ThermalCapture 2.0 is a standalone camera with its own GPS and
power supply (does not get information from the UAV). In our
sensor-platform configuration it is used together with the Micasense
Altum-PT, which receives RTK GPS signals from our UAV (DJI Matrice 300
RTK). The ThermalCapture’s GPS information is only used to derive
accurate timestamps. Subsequently, the accurate timestamps can then be
used to retrieve the corresponding RTK GPS signal from the Micasense
Altum-PT through interpolation. The co-registration has two options: -
Directy: use the GPS and orientation data from the co-registered camera
directly - Indirectly: First, align the cameras from the co-registered
camera in Agisoft Metashape, export the optimized camera locations as
csv file and these optimized GPS and orientation data.</p>
<p>In Both cases we first need to call the <code><a href="../reference/coreg_prep.html">coreg_prep()</a></code> to
prepare the data in the right format:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt_cameras</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/coreg_prep.html">coreg_prep</a></span><span class="op">(</span>img_path <span class="op">=</span> <span class="st">"E:/Thermal_Project/data_Micasense/"</span>,</span>
<span>                          SfM_option <span class="op">=</span> <span class="st">"Agisoft Metashape"</span>,</span>
<span>                          opt_camera_path <span class="op">=</span> <span class="st">"E:/Thermal_Project/Reference_Cameras_Thermal_Project.txt"</span>,</span>
<span>                          camera_name <span class="op">=</span> <span class="st">"Altum-PT_MSP"</span>,</span>
<span>                          label <span class="op">=</span> <span class="st">"_2"</span>,</span>
<span>                          timezone <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span></span></code></pre></div>
<p>This should have returned a data.frame with 9 variables. We can now
use this in the <code><a href="../reference/tuav_coreg.html">tuav_coreg()</a></code> function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thermal_uav_teax_coreg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tuav_coreg.html">tuav_coreg</a></span><span class="op">(</span><span class="va">thermal_uav_teax_clean</span>,</span>
<span>                                     opt_cameras <span class="op">=</span> <span class="va">opt_cameras</span>,</span>
<span>                                     rig_offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                                     timediff <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>Optionally you can call the <code><a href="../reference/tuav_view.html">tuav_view()</a></code> function again
on the latest ThermalUAV object to check if the camera locations are
still places correctly (serves as quick visual check).</p>
</div>
<div class="section level3">
<h3 id="conversion-to-lst-1">3.4. Conversion to LST<a class="anchor" aria-label="anchor" href="#conversion-to-lst-1"></a>
</h3>
<p>If you are satisfied with the performed corrections, we can now move
to the conversion of the brightness temperature to LST. Note, the
cleaning functions can also be performed after this step, but it will
require much longer computation time. As explained in <a href="#conversion-to-lst">2.2. Conversion to LST</a>, we use the
function <code><a href="../reference/tuav_correct.html">tuav_correct()</a></code> to perform the conversion.</p>
<p>During this rather long flight, weather variables were collected
simultaneous at a 5-second interval rate using the Kestrel 5500. This
data first needs to be loaded an put into the right format. you can
chekc the structure using the <code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code> function. Datetime, can
be easily converted to POSIXct using <code><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct()</a></code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Kestrel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"E:/Thermal_Project/Weather_data/Kestrel_tair_relhum.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">Kestrel</span><span class="op">)</span>      <span class="co"># datetime is as character -&gt; convert to POSIXct</span></span>
<span><span class="va">Kestrel</span><span class="op">$</span><span class="va">datetime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="va">Kestrel</span><span class="op">$</span><span class="va">datetime</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span></span></code></pre></div>
<p>After obtaining the data.frame in the right format, it can be used in
the <code><a href="../reference/tuav_correct.html">tuav_correct()</a></code> function</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thermal_uav_teax_correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tuav_correct.html">tuav_correct</a></span><span class="op">(</span><span class="va">thermal_uav_teax_coreg</span>,          </span>
<span>                                    flight_height <span class="op">=</span> <span class="cn">NA</span>,   <span class="co"># in meters</span></span>
<span>                                    T_air <span class="op">=</span> <span class="va">Kestrel</span>,      <span class="co"># data.frame in °C</span></span>
<span>                                    rel_hum <span class="op">=</span> <span class="va">Kestrel</span>,    <span class="co"># data.frame in %</span></span>
<span>                                    T_bg <span class="op">=</span> <span class="fl">268.26</span>,        <span class="co"># in Kelvin</span></span>
<span>                                    emiss <span class="op">=</span> <span class="fl">0.985</span><span class="op">)</span>        </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="smooth">3.5. Smooth<a class="anchor" aria-label="anchor" href="#smooth"></a>
</h3>
<p>Optionally an additional smoothing procedure can be applied to avoid
the influence of large fluctuations in T_air on the dataset. This
smoothing correction is based on the following formula from <a href="https://doi.org/10.3390/rs9050476" class="external-link">this paper</a>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>T</mi><msub><mi>S</mi><mrow><mi>s</mi><mi>m</mi><mi>o</mi><mi>o</mi><mi>t</mi><mi>h</mi></mrow></msub></msub><mo>=</mo><msub><mi>T</mi><mi>s</mi></msub><mo>−</mo><msub><mi>T</mi><mrow><mi>a</mi><mi>i</mi><mi>r</mi></mrow></msub><mo>+</mo><msub><mi>T</mi><mrow><mi>a</mi><mi>i</mi><msub><mi>r</mi><mrow><mi>m</mi><mi>e</mi><mi>a</mi><mi>n</mi></mrow></msub></mrow></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align*}
T_{S_{smooth}} = T_{s} - T_{air} + T_{air_{mean}} 
\end{align*}
</annotation></semantics></math></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thermal_uav_teax_smooth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tuav_smooth.html">tuav_smooth</a></span><span class="op">(</span><span class="va">thermal_uav_teax_correct</span>,          </span>
<span>                                    method <span class="op">=</span> <span class="st">"T_air"</span><span class="op">)</span>        </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="export-and-report-1">3.6. Export and report<a class="anchor" aria-label="anchor" href="#export-and-report-1"></a>
</h3>
<p>Now we are back at the point where we need to export the images and
process them in an external photogrammetry software like Agisoft
Metashape. Check section <a href="#export-and-report">2.3. Export and
report</a> for more details.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tuav_export.html">tuav_export</a></span><span class="op">(</span><span class="va">thermal_uav_teax_smooth</span>,</span>
<span>            export_path <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>     </span></code></pre></div>
<p>Optionally, if desired, you can also create an HTM-report using
<code><a href="../reference/tuav_report.html">tuav_report()</a></code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tuav_report.html">tuav_report</a></span><span class="op">(</span><span class="va">thermal_uav_teax_smooth</span>,</span>
<span>            project_name <span class="op">=</span> <span class="st">"Thermal_Project_TeAx"</span>,</span>
<span>            flight_name <span class="op">=</span> <span class="st">"Flight 1"</span>,</span>
<span>            pilot_name <span class="op">=</span> <span class="st">"Pilot X"</span>,</span>
<span>            location <span class="op">=</span> <span class="st">"Flightblock Y"</span><span class="op">)</span>     </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="optional-spatial-emissivity-correction-1">3.7. Optional Spatial Emissivity Correction<a class="anchor" aria-label="anchor" href="#optional-spatial-emissivity-correction-1"></a>
</h3>
<p>In section <a href="#optional-spatial-emissivity-correction">2.4.
Optional Spatial Emissivity Correction</a> we already discussed the
option to account for spatially explicit post-processing emissivity
correction. In the previous example we used the NDVI threshold method.
In this case we will show the landcover option. This option
requires:</p>
<ol style="list-style-type: upper-alpha">
<li>Landcover map (LC)</li>
<li>Two column matrix containing the landcover labels with their
corresponding emissivity values</li>
</ol>
<p>In the example below, a LC map is provided with 5 classes as shown in
the table below:</p>
<table class="table">
<thead><tr class="header">
<th>Label</th>
<th>Class</th>
<th>Emissivity</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Shrubs/green low vegetation</td>
<td>0.984</td>
</tr>
<tr class="even">
<td>2</td>
<td>Dry vegetation/mosses</td>
<td>0.962</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Trees</td>
<td>0.983</td>
</tr>
<tr class="even">
<td>4</td>
<td>Sandy bare soil</td>
<td>0.914</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Water</td>
<td>0.991</td>
</tr>
</tbody>
</table>
<p>The emissivity values were taken from Salisbury and D’Aria (1994) and
Rubio, E., et al. (1997). First we will load the LC map and create the
two-column matrix containing the labels with their corresponding
emissivity value.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the LC map as SpatRaster</span></span>
<span><span class="va">LC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"E:/Thermal_Project/LC_TeAx.tif"</span><span class="op">)</span></span>
<span><span class="co"># Create two-column matrix </span></span>
<span><span class="va">matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span>,<span class="fl">0.984</span>,<span class="fl">0.962</span>,<span class="fl">0.983</span>, <span class="fl">0.914</span>,<span class="fl">0.991</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the LST data as SpatRaster</span></span>
<span><span class="va">LST_teax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"E:/Thermal_Project/LST_TeAx.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LC</span>, main <span class="op">=</span> <span class="st">"Landcover"</span>, type <span class="op">=</span> <span class="st">"classes"</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Shrubs"</span>, <span class="st">"Mosses"</span>, <span class="st">"Trees"</span>, <span class="st">"Sandy soil"</span>, <span class="st">"Water"</span><span class="op">)</span>, legend <span class="op">=</span> <span class="st">"topleft"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LST_teax</span>, main <span class="op">=</span> <span class="st">"LST in °C"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"magma"</span><span class="op">)</span>, range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span>,<span class="fl">30</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures%2FIm_teax_LC.png" width="100%"><img src="figures%2FIm_teax_LST.png" width="100%"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LST_teax_emis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tuav_emis.html">tuav_emis</a></span><span class="op">(</span>thermal_orig <span class="op">=</span> <span class="va">LST_teax</span>,</span>
<span>                      thermal_uav <span class="op">=</span> <span class="va">thermal_uav_teax_smooth</span>, <span class="co"># The last ThermalUAV object, </span></span>
<span>                      temp <span class="op">=</span> <span class="st">"C"</span>, <span class="co"># LST is in this case in °C</span></span>
<span>                      corrmap <span class="op">=</span> <span class="va">LC</span>,</span>
<span>                      method <span class="op">=</span> <span class="st">"LC"</span>, <span class="co"># Here we use the LC method</span></span>
<span>                      write_Ts <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># If you want to write the output</span></span>
<span>                      filename_Ts <span class="op">=</span> <span class="st">"E:/Thermal_Project/LST_TeAx_emis.tif"</span>,</span>
<span>                      write_emiss <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># Optionally you can save the emissivity raster file</span></span>
<span>                      filename_emiss <span class="op">=</span> <span class="st">"E:/Thermal_Project/Emis_ortho_TeAx.tif"</span>,</span>
<span>                      LC_emiss_matrix <span class="op">=</span> <span class="va">matrix</span><span class="op">)</span></span></code></pre></div>
<p>After correcting for the spatially explicit emissivity, the LST map
is final and can be plotted or used for your analysis.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LST_teax_emis</span>, main <span class="op">=</span> <span class="st">"LST corrected for ϵ"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/mappal.html" class="external-link">map.pal</a></span><span class="op">(</span><span class="st">"magma"</span><span class="op">)</span>, range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span>,<span class="fl">30</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures%2FIm_teax_LST_corr.png" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Salisbury, J.W. and D’Aria, D.M. (1994) ‘Emissivity of terrestrial
materials in the 3-5 μm atmospheric window’, Remote Sensing of
Environment, 47(3), pp. 345–361. Available at: <a href="https://doi.org/10.1016/0034-4257(94)90102-3" class="external-link uri">https://doi.org/10.1016/0034-4257(94)90102-3</a>.</li>
<li>Rubio, E., Caselles, V. and Badenas, C. (1997) ‘Emissivity
Measurements of Several Soils and Vegetation Types in the 8-14/ m Wave
Band: Analysis of Two Field Methods’, Remote Sensing of Environment,
59(3), pp. 490-521. Available at: <a href="https://doi.org/10.1016/S0034-4257(96)00123-X" class="external-link uri">https://doi.org/10.1016/S0034-4257(96)00123-X</a>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christophe Metsu.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
